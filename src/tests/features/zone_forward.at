FWD_START_TEST([zone - forward])
AT_KEYWORDS(forward gh586 gh613)

FWD_CHECK([--zone=home --add-interface=dummy --add-interface=dummy2], 0, ignore)
FWD_CHECK([--zone=home --add-forward], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_home_allow], 0, [dnl
    table inet firewalld {
    chain filter_FWD_home_allow {
    oifname "dummy" accept
    oifname "dummy2" accept
    }
    }
])
dnl These two ipXtables rules correspond to:
dnl   -A FWD_home_allow -o dummy -j ACCEPT
dnl   -A FWD_home_allow -o dummy2 -j ACCEPT
dnl although we can't assert the interface names because they don't
dnl appear in these rule listings, unfortunately...
IPTABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
])
IP6TABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- ::/0 ::/0
    ACCEPT 0 -- ::/0 ::/0
])
dnl Forward rules should be updated when the interfaces change
FWD_CHECK([--zone=home --remove-interface=dummy2], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_home_allow], 0, [dnl
    table inet firewalld {
    chain filter_FWD_home_allow {
    oifname "dummy" accept
    }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
])
IP6TABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- ::/0 ::/0
])
FWD_CHECK([--zone=home --add-interface=dummy3], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_home_allow], 0, [dnl
    table inet firewalld {
    chain filter_FWD_home_allow {
    oifname "dummy" accept
    oifname "dummy3" accept
    }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
])
IP6TABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- ::/0 ::/0
    ACCEPT 0 -- ::/0 ::/0
])
FWD_CHECK([--zone=home --query-forward], 0, ignore)
FWD_CHECK([--zone=home --remove-forward], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_home_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_home_allow {
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
])
IP6TABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
])
FWD_CHECK([--zone=home --query-forward], 1, ignore)
FWD_CHECK([--zone=home --remove-interface=dummy --remove-interface=dummy3], 0, ignore)

FWD_CHECK([--permanent --zone=home --add-forward], 0, ignore)
FWD_CHECK([-q --permanent --zone=home --add-interface=dummy --add-interface=dummy3])
FWD_CHECK([-q --permanent --zone=home --add-source=10.10.10.0/24])
FWD_RELOAD
FWD_CHECK([--permanent --zone=home --query-forward], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_home_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_home_allow {
            oifname "dummy" accept
            oifname "dummy3" accept
            ip daddr 10.10.10.0/24 accept
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
    ACCEPT 0 -- 0.0.0.0/0 10.10.10.0/24
])
IP6TABLES_LIST_RULES([filter], [FWD_home_allow], 0, [dnl
    ACCEPT 0 -- ::/0 ::/0
    ACCEPT 0 -- ::/0 ::/0
])
FWD_CHECK([--permanent --zone=home --remove-forward], 0, ignore)
FWD_CHECK([--permanent --zone=home --query-forward], 1, ignore)
FWD_CHECK([-q --permanent --zone=home --remove-interface=dummy --remove-interface=dummy3])
FWD_CHECK([-q --permanent --zone=home --remove-source=10.10.10.0/24])
FWD_RELOAD

dnl verify enabled in default zone doesn't add a wildcard/catch-all entry
FWD_CHECK([--get-default-zone |grep public], 0, [ignore])
FWD_CHECK([-q --add-interface dummy4])
FWD_CHECK([-q --add-forward])
NFT_LIST_RULES([inet], [filter_FWD_public_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_public_allow {
            oifname "dummy4" accept
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_public_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 0.0.0.0/0
])
IP6TABLES_LIST_RULES([filter], [FWD_public_allow], 0, [dnl
    ACCEPT 0 -- ::/0 ::/0
])

dnl zone source
FWD_CHECK([--zone=internal --add-source=10.10.10.0/24], 0, ignore)
IF_HOST_SUPPORTS_IPV6_RULES([
FWD_CHECK([--zone=internal --add-source=1234::/64], 0, ignore)
])
FWD_CHECK([--zone=internal --add-forward], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_internal_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_internal_allow {
            ip daddr 10.10.10.0/24 accept
            ip6 daddr 1234::/64 accept
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 10.10.10.0/24
])
IP6TABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
    ACCEPT 0 -- ::/0 1234::/64
])
IF_HOST_SUPPORTS_IPV6_RULES([
FWD_CHECK([--zone=internal --remove-source=1234::/64], 0, ignore)
])
NFT_LIST_RULES([inet], [filter_FWD_internal_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_internal_allow {
            ip daddr 10.10.10.0/24 accept
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 10.10.10.0/24
])
IP6TABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
])
FWD_CHECK([--zone=internal --add-source=10.20.20.0/24], 0, ignore)
IF_HOST_SUPPORTS_IPV6_RULES([
FWD_CHECK([--zone=internal --add-source=4321::/64], 0, ignore)
])
NFT_LIST_RULES([inet], [filter_FWD_internal_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_internal_allow {
            ip daddr 10.10.10.0/24 accept
            ip daddr 10.20.20.0/24 accept
            ip6 daddr 4321::/64 accept
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
    ACCEPT 0 -- 0.0.0.0/0 10.10.10.0/24
    ACCEPT 0 -- 0.0.0.0/0 10.20.20.0/24
])
IP6TABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
    ACCEPT 0 -- ::/0 4321::/64
])
FWD_CHECK([--zone=internal --remove-forward], 0, ignore)
NFT_LIST_RULES([inet], [filter_FWD_internal_allow], 0, [dnl
    table inet firewalld {
        chain filter_FWD_internal_allow {
        }
    }
])
IPTABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
])
IP6TABLES_LIST_RULES([filter], [FWD_internal_allow], 0, [dnl
])

FWD_END_TEST()
