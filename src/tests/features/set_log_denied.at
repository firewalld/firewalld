FWD_START_TEST([log denied pkttype])
AT_KEYWORDS(log_denied gh1518)

FWD_CHECK([--set-log-denied off], 0, [ignore], [ignore])
NFT_LIST_RULES([inet], [filter_INPUT_POLICIES], 0, [dnl
    table inet firewalld {
        chain filter_INPUT_POLICIES {
            jump filter_IN_policy_allow-host-ipv6
            jump filter_IN_public
            reject with icmpx admin-prohibited
        }
    }
])
IPTABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- 0.0.0.0/0 0.0.0.0/0
    IN_public 0 -- 0.0.0.0/0 0.0.0.0/0
    REJECT 0 -- 0.0.0.0/0 0.0.0.0/0 reject-with icmp-port-unreachable
])
IP6TABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- ::/0 ::/0
    IN_public 0 -- ::/0 ::/0
    REJECT 0 -- ::/0 ::/0 reject-with icmp6-port-unreachable
])

FWD_CHECK([--set-log-denied all], 0, [ignore])
NFT_LIST_RULES([inet], [filter_INPUT_POLICIES], 0, [dnl
    table inet firewalld {
        chain filter_INPUT_POLICIES {
            jump filter_IN_policy_allow-host-ipv6
            jump filter_IN_public
            log prefix "filter_IN_public_REJECT: "
            reject with icmpx admin-prohibited
        }
    }
])
IPTABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- 0.0.0.0/0 0.0.0.0/0
    IN_public 0 -- 0.0.0.0/0 0.0.0.0/0
    LOG 0 -- 0.0.0.0/0 0.0.0.0/0 LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- 0.0.0.0/0 0.0.0.0/0 reject-with icmp-port-unreachable
])
IP6TABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- ::/0 ::/0
    IN_public 0 -- ::/0 ::/0
    LOG 0 -- ::/0 ::/0 LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- ::/0 ::/0 reject-with icmp6-port-unreachable
])

FWD_CHECK([--set-log-denied unicast], 0, [ignore])
NFT_LIST_RULES([inet], [filter_INPUT_POLICIES], 0, [dnl
    table inet firewalld {
        chain filter_INPUT_POLICIES {
            jump filter_IN_policy_allow-host-ipv6
            jump filter_IN_public
            meta pkttype host log prefix "filter_IN_public_REJECT: "
            reject with icmpx admin-prohibited
        }
    }
])
IPTABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- 0.0.0.0/0 0.0.0.0/0
    IN_public 0 -- 0.0.0.0/0 0.0.0.0/0
    LOG 0 -- 0.0.0.0/0 0.0.0.0/0 PKTTYPE = unicast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- 0.0.0.0/0 0.0.0.0/0 reject-with icmp-port-unreachable
])
IP6TABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- ::/0 ::/0
    IN_public 0 -- ::/0 ::/0
    LOG 0 -- ::/0 ::/0 PKTTYPE = unicast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- ::/0 ::/0 reject-with icmp6-port-unreachable
])

FWD_CHECK([--set-log-denied broadcast], 0, [ignore])
NFT_LIST_RULES([inet], [filter_INPUT_POLICIES], 0, [dnl
    table inet firewalld {
        chain filter_INPUT_POLICIES {
            jump filter_IN_policy_allow-host-ipv6
            jump filter_IN_public
            meta pkttype broadcast log prefix "filter_IN_public_REJECT: "
            reject with icmpx admin-prohibited
        }
    }
])
IPTABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- 0.0.0.0/0 0.0.0.0/0
    IN_public 0 -- 0.0.0.0/0 0.0.0.0/0
    LOG 0 -- 0.0.0.0/0 0.0.0.0/0 PKTTYPE = broadcast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- 0.0.0.0/0 0.0.0.0/0 reject-with icmp-port-unreachable
])
IP6TABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- ::/0 ::/0
    IN_public 0 -- ::/0 ::/0
    LOG 0 -- ::/0 ::/0 PKTTYPE = broadcast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- ::/0 ::/0 reject-with icmp6-port-unreachable
])

FWD_CHECK([--set-log-denied multicast], 0, [ignore])
NFT_LIST_RULES([inet], [filter_INPUT_POLICIES], 0, [dnl
    table inet firewalld {
        chain filter_INPUT_POLICIES {
            jump filter_IN_policy_allow-host-ipv6
            jump filter_IN_public
            meta pkttype multicast log prefix "filter_IN_public_REJECT: "
            reject with icmpx admin-prohibited
        }
    }
])
IPTABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- 0.0.0.0/0 0.0.0.0/0
    IN_public 0 -- 0.0.0.0/0 0.0.0.0/0
    LOG 0 -- 0.0.0.0/0 0.0.0.0/0 PKTTYPE = multicast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- 0.0.0.0/0 0.0.0.0/0 reject-with icmp-port-unreachable
])
IP6TABLES_LIST_RULES([filter], [INPUT_POLICIES], 0, [dnl
    IN_allow-host-ipv6 0 -- ::/0 ::/0
    IN_public 0 -- ::/0 ::/0
    LOG 0 -- ::/0 ::/0 PKTTYPE = multicast LOG flags 0 level 4 prefix "IN_public_REJECT: "
    REJECT 0 -- ::/0 ::/0 reject-with icmp6-port-unreachable
])

FWD_END_TEST([-e '/WARNING: ALREADY_SET: off/d'])
